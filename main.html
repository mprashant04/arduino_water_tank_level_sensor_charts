<html>
  <head>
  <title>Water Tank Level Sensor</title>

<style type="text/css">
  body { background-color: #ffffff; }
  #container { height: 100%; width: 100%; display: table; }
  #inner { vertical-align: middle; display: table-cell; }
  #gauge_div { width: 120px; margin: 0 auto; }
</style>

<script type='text/javascript' src='https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js'></script>
<!--script src="https://cdn.jsdelivr.net/npm/chart.js"></script-->
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.4.0/Chart.bundle.js"></script>

<script>

lastSamples= 200;
enableAutoRefresh = 1;

 // Add a helper to format timestamp data
Date.prototype.formatMMDDYYYY = function() {
	return (this.getMonth() + 1) +
	"/" +  this.getDate() +
	"/" +  this.getFullYear() ;
}

Date.prototype.formatMMDDYYYYHHMMSS = function() {
	return pad((this.getMonth() + 1),2) +
	"/" +  pad(this.getDate(),2) +
	"/" +  pad(this.getFullYear(),4) +
	" " +  pad(this.getHours(),2)  +
	":" +  pad(this.getMinutes(),2) +
	":" +  pad(this.getSeconds(),2)
	;
}

Date.prototype.formatHHMM = function() {
	return this.getHours() + ":" +  pad(this.getMinutes(),2);
}

Date.prototype.formatHHMMSS = function() {
	return this.getHours() + ":" +  pad(this.getMinutes(),2) + ":" +  pad(this.getSeconds(),2);
}

function pad(num, size) {
    num = num.toString();
    while (num.length < size) num = "0" + num;
    return num;
}
function getParameterByName(name, url = window.location.href) {
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
}


chartObjects = {};



  function drawLineChart(chartLabel, fieldNumber, canvasId,  lineColor, pointColor) {

   
    var jsonData = $.ajax({
      url: 'https://api.thingspeak.com/channels/1440877/fields/' + fieldNumber + '.json?results=' + getParameterByName('samples'),
      dataType: 'json',
    }).done(function (results) {

      // Split timestamp and data into separate arrays
      var labels = [], data=[];
      results["feeds"].forEach(function(packet) {
        //labels.push(new Date(packet.created_at).formatHHMM());
		//labels.push(new Date(packet.created_at));
        //data.push(parseFloat(packet["field"  + fieldNumber]));
		
		val = { x:null, y:null};
		val.x = new Date(packet.created_at).formatMMDDYYYYHHMMSS();
		val.y = parseFloat(packet["field"  + fieldNumber]);
		data.push (val);		
      });
  
   

      // Get the context of the canvas element we want to select
      var ctx = document.getElementById(canvasId).getContext("2d");

      // Instantiate a new chart
	  
	  if (chartObjects[chartLabel] != null){
		chartObjects[chartLabel].destroy();
	  }
	  
	  //var timeFormat = 'DD/MM/YYYY';
	  var timeFormat = 'MM/DD/YYYY HH:mm:SS';
	  
	  var config = {
        type:    'line',
        data:    {
            datasets: [
                {
                    label: chartLabel,                    
					data: data,
                    fill: false,
                    borderColor: lineColor,
					borderDash: [3, 3],
					backgroundColor: pointColor,
					pointBackgroundColor: pointColor,
					pointBorderColor: pointColor,
					pointHoverBackgroundColor: pointColor,
					pointHoverBorderColor: pointColor,
                }            
			]
        },
        options: {
            responsive: true,
            title:      {
                display: true,
                text:    chartLabel
            },
			legend: {
				display: false
			},
            scales:     {
                xAxes: [{
                    type:       "time",
                    time:       {
                        format: timeFormat,
                        tooltipFormat: 'll'
                    }
                }],
                yAxes: [{
                    
                }]
            }
        }
    };

	  
	chartObjects[chartLabel] =  new Chart(ctx, config);

      
    });
  }

	
		
	function displayCharts(){		
		
		drawLineChart("Signal", "1", "lineChartSignal", "#0080ff","#6666ff");
		drawLineChart("Level %", "2", "lineChartPercent", "#99cc00","#33cc00");
		
		if (document.getElementById('info') != null){
			document.getElementById('info').innerHTML = new Date().formatHHMMSS() + " (" + getParameterByName('samples') + ")";
		}  		
	}
	
	function reloadPage(){
		if (enableAutoRefresh ==1){
			window.location.reload();
		}
		//window.location = window.location;
	}
	
	function redirect(samples){
		window.location.replace('https://mprashant04.github.io/arduino_water_tank_level_sensor_charts/main.html?samples=' + samples);
		//window.location.replace('file:///C:/Users/e083356/Desktop/Temp/main.html?samples=' + samples);
	}
	
	function disableRefresh(){
	      enableAutoRefresh = 0;
	      document.getElementById('info').innerHTML = "Disabled...";
	}
  
	
	
	if (getParameterByName('samples') == null){
		redirect (200);
	}
	
	setInterval(reloadPage, 5000);
	
	window.onload = function() {
		displayCharts();	
	};
	
 
</script>

  </head>
  <body>
    <div id="container">
      <div id="inner">
	  
	  <button onclick="redirect(50)">50</button>
	  <button onclick="redirect(100)">100</button>
	  <button onclick="redirect(200)">200</button>
	  <button onclick="redirect(300)">300</button>
	  <button onclick="redirect(400)">400</button>
	  <button onclick="redirect(500)">500</button>
	  <button onclick="redirect(750)">750</button>
	  <button onclick="redirect(1000)">1000</button>
	  <button onclick="redirect(1500)">1500</button>
	  <button onclick="redirect(2000)">2000</button>	  
	  <button onclick="redirect(4000)">4000</button>	  
	  <button onclick="redirect(8000)">8000</button>	  
	  <button onclick="disableRefresh()">Disable refresh</button>	  
	  <label id="info"/>   </label>
	  
	  
	  <canvas  id="lineChartSignal"  width="300" height="55"  style="border:1px solid black"></canvas>
	  <canvas  id="lineChartPercent"  width="300" height="55"  style="border:1px solid black"></canvas>
	  		
	 
    </div>
  </body>
</html>

